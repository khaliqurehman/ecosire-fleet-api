<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        
        <!-- Inherit the main partner form view with conditional field display -->
        <record id="view_partner_form_inherit_ecosire_fleet_api" model="ir.ui.view">
            <field name="name">res.partner.form.inherit.ecosire.fleet.api</field>
            <field name="model">res.partner</field>
            <field name="inherit_id" ref="base.view_partner_form"/>
            <field name="arch" type="xml">
                <!-- Hide the original company_type field and replace with our contact_type field -->
                <xpath expr="//field[@name='company_type']" position="replace">
                    <field name="contact_type" widget="radio" options="{'horizontal': true}"/>
                </xpath>
                
                <!-- Hide company name for individuals and drivers -->
                <xpath expr="//field[@name='name']" position="attributes">
                    <attribute name="invisible">contact_type != 'company'</attribute>
                </xpath>
                
                <!-- Hide state/province field -->
                <xpath expr="//field[@name='state_id']" position="attributes">
                    <attribute name="invisible">1</attribute>
                </xpath>
                
                <!-- Hide zip/postal code field -->
                <xpath expr="//field[@name='zip']" position="attributes">
                    <attribute name="invisible">1</attribute>
                </xpath>
                
                <!-- Hide street2 field -->
                <xpath expr="//field[@name='street2']" position="attributes">
                    <attribute name="invisible">1</attribute>
                </xpath>
                
                <!-- Hide VAT/Tax ID field for individuals and drivers, change label to VAT for companies -->
                <xpath expr="//field[@name='vat']" position="attributes">
                    <attribute name="invisible">contact_type not in ['company']</attribute>
                    <attribute name="string">VAT</attribute>
                </xpath>
                
                <!-- Add commercial registration field after VAT field -->
                <xpath expr="//field[@name='vat']" position="after">
                    <field name="commercial_registration" 
                           placeholder="e.g. CR123456789"
                           invisible="contact_type != 'company'"/>
                </xpath>
                
                <!-- Add Iqama/ID Number field for individuals and drivers -->
                <xpath expr="//field[@name='vat']" position="after">
                    <field name="x_studio_iqama_number" 
                           placeholder="ID/Iqama Number"
                           invisible="contact_type == 'company'"/>
                </xpath>
                
                <!-- Add driver-specific fields in a dedicated section -->
                <xpath expr="//form/sheet/notebook" position="inside">
                    <page string="Driver Information" name="driver_info" invisible="contact_type != 'driver'">
                        <group string="Driver License Information" col="2">
                            <field name="driver_license_number" placeholder="e.g. DL123456789"/>
                            <field name="driver_license_class"/>
                            <field name="driver_license_expiry"/>
                        </group>
                        <group string="Driver Identification" col="2">
                            <field name="issue_number" placeholder="e.g. ISS123456"/>
                        </group>
                        <group string="Fleet Assignment" col="2">
                            <field name="vehicle_assigned_id" placeholder="Select a vehicle from the fleet"/>
                        </group>
                    </page>
                </xpath>
                
                <!-- Add a dedicated Location tab in the notebook for clarity -->
                <xpath expr="//form/sheet/notebook" position="inside">
                    <page string="Location" name="ecosire_location">
                        <group string="Location Information" col="2">
                            <field name="partner_latitude" string="Latitude"/>
                            <field name="partner_longitude" string="Longitude"/>
                            <field name="location_display" readonly="1" optional="hide"/>
                            <button name="action_set_location_from_address"
                                    string="Get Location from Address"
                                    type="object"
                                    class="btn-secondary"
                                    invisible="not street or not city"/>
                        </group>
                    </page>
                </xpath>
            </field>
        </record>

        <!-- Inherit the partner tree view to show commercial registration and ID -->
        <record id="view_partner_tree_inherit_ecosire_fleet_api" model="ir.ui.view">
            <field name="name">res.partner.tree.inherit.ecosire.fleet.api</field>
            <field name="model">res.partner</field>
            <field name="inherit_id" ref="base.view_partner_tree"/>
            <field name="arch" type="xml">
                <!-- Add contact type column -->
                <xpath expr="//field[@name='email']" position="after">
                    <field name="contact_type" optional="hide"/>
                </xpath>
                <!-- Add commercial registration column -->
                <xpath expr="//field[@name='email']" position="after">
                    <field name="commercial_registration" optional="hide"/>
                </xpath>
                <!-- Add ID/Iqama number column -->
                <xpath expr="//field[@name='email']" position="after">
                    <field name="x_studio_iqama_number" optional="hide"/>
                </xpath>
                <!-- Add driver-specific columns -->
                <xpath expr="//field[@name='email']" position="after">
                    <field name="vehicle_assigned_id" optional="hide"/>
                </xpath>
            </field>
        </record>

        <!-- Inherit the partner search view to add search filters -->
        <record id="view_res_partner_filter_inherit_ecosire_fleet_api" model="ir.ui.view">
            <field name="name">res.partner.search.inherit.ecosire.fleet.api</field>
            <field name="model">res.partner</field>
            <field name="inherit_id" ref="base.view_res_partner_filter"/>
            <field name="arch" type="xml">
                <!-- Add search filters for contact type and commercial registration -->
                <xpath expr="//field[@name='email']" position="after">
                    <field name="contact_type"/>
                    <field name="commercial_registration"/>
                    <field name="driver_license_number"/>
                    <field name="x_studio_iqama_number"/>
                    <field name="issue_number"/>
                    <field name="vehicle_assigned_id"/>
                </xpath>
                
                <!-- Add filters inside the search node for broader compatibility -->
                <xpath expr="//search" position="inside">
                    <separator/>
                    <filter string="Drivers" name="drivers" domain="[('contact_type', '=', 'driver')]"/>
                    <filter string="Companies" name="companies" domain="[('contact_type', '=', 'company')]"/>
                    <filter string="Individuals" name="individuals" domain="[('contact_type', '=', 'individual')]"/>
                    <separator/>
                    <filter string="Has Location Data" name="has_location"
                            domain="[('partner_latitude', '!=', False), ('partner_longitude', '!=', False)]"/>
                    <filter string="No Location Data" name="no_location"
                            domain="['|', ('partner_latitude', '=', False), ('partner_longitude', '=', False)]"/>
                    <separator/>
                    <filter string="License Expiring Soon" name="license_expiring"
                            domain="[('contact_type', '=', 'driver'), ('driver_license_expiry', '&lt;=', (context_today() + relativedelta(days=30)).strftime('%Y-%m-%d'))]"/>
                    <separator/>
                    <group expand="0" string="Group By">
                        <filter string="Contact Type" name="group_contact_type" context="{'group_by': 'contact_type'}"/>
                        <filter string="Assigned Vehicle" name="group_vehicle" context="{'group_by': 'vehicle_assigned_id'}"/>
                    </group>
                </xpath>
            </field>
        </record>

    </data>
</odoo>
